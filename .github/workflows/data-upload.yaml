name: Data Upload & Validation

# Triggers on push to data/* branches (timestamped branches created by hook or staging)
# Excludes magic branches handled by data-staging.yaml
on:
  push:
    branches:
      - 'data/**'
      - '!data/staging'
      - '!data/new'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install opencv-python numpy Pillow PyYAML dvc[s3] boto3

      - name: Run Data QA Validation
        id: data_qa
        run: |
          echo "Running data quality assurance..."
          python devops/scripts/data-qa.py WMS/data/training/ --output report.json

          # Capture exit code
          QA_STATUS=$?

          # Read report
          REPORT=$(cat report.json)

          # Set outputs
          echo "status=$QA_STATUS" >> $GITHUB_OUTPUT
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $QA_STATUS

      # If QA PASSED: DVC add/push and create PR
      - name: Configure AWS credentials
        if: steps.data_qa.outputs.status == '0'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Configure DVC
        if: steps.data_qa.outputs.status == '0'
        run: |
          # DVC config should already be set in .dvc/config
          dvc remote list

      - name: DVC add and push training data
        if: steps.data_qa.outputs.status == '0'
        run: |
          echo "Checking if data is tracked by Git or DVC..."

          # Check if data is in Git (POC mode) or needs DVC
          if git ls-files --error-unmatch WMS/data/training/images/ > /dev/null 2>&1; then
            echo "âš ï¸  Training data is tracked by Git (POC mode)"
            echo "Skipping DVC add/push"
            echo "For production, move to DVC tracking for large datasets"
          else
            echo "Adding training data to DVC..."
            # Add images and masks to DVC
            dvc add WMS/data/training/images
            dvc add WMS/data/training/masks

            # Push to S3
            echo "Pushing data to S3..."
            dvc push
          fi

          # Commit .dvc files
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add WMS/data/training/*.dvc
          git commit -m "dvc: update training data" || echo "No changes to commit"
          git push origin ${{ github.ref_name }}

      - name: Create or Update Pull Request
        if: steps.data_qa.outputs.status == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const report = JSON.parse(`${{ steps.data_qa.outputs.report }}`);

            // Check if PR already exists
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              base: 'main',
              state: 'open'
            });

            const prBody = `## Training Data Validation - PASSED âœ…

            New training data has been uploaded and validated successfully.

            ### Validation Report

            - **Images**: ${report.image_count}
            - **Masks**: ${report.mask_count}
            - **Valid pairs**: ${report.valid_pairs}
            - **Resolution**: ${report.statistics.resolution || 'N/A'}
            - **Median coverage**: ${report.statistics['median_coverage_%'] || 'N/A'}%

            ### Next Steps

            1. Training pipeline will run automatically on this PR
            2. Up to 3 training attempts with different seeds
            3. Quality gate will compare against baseline metrics
            4. If model improves, PR will be auto-approved
            5. Merge to deploy the new model

            ### DVC Data

            Training data has been versioned and pushed to S3 via DVC.

            ---
            ðŸ¤– Generated by [GitHub Actions](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;

            if (existingPRs.length > 0) {
              // Update existing PR
              const pr = existingPRs[0];
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: prBody
              });
              console.log(`Updated existing PR #${pr.number}`);
            } else {
              // Create new PR
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Training Data Update: ${branch}`,
                head: branch,
                base: 'main',
                body: prBody
              });
              console.log(`Created PR #${pr.data.number}`);
            }

      # If QA FAILED: Post error comment on commit
      - name: Post validation errors
        if: failure() && steps.data_qa.outputs.status != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const report = JSON.parse(`${{ steps.data_qa.outputs.report }}`);

            let errorList = '';
            if (report.errors && report.errors.length > 0) {
              errorList = report.errors.slice(0, 10).map(e => `- ${e}`).join('\n');
              if (report.errors.length > 10) {
                errorList += `\n- ... and ${report.errors.length - 10} more errors`;
              }
            }

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## Data Validation FAILED âŒ

            Training data validation failed. Please fix the following issues and push again.

            ### Errors

            ${errorList || 'Unknown error - check workflow logs'}

            ### Statistics

            - **Images**: ${report.image_count || 0}
            - **Masks**: ${report.mask_count || 0}
            - **Valid pairs**: ${report.valid_pairs || 0}

            ### How to Fix

            1. Review the errors above
            2. Fix the issues in your local repository
            3. Commit and push to the same branch (\`${context.ref.replace('refs/heads/', '')}\`)
            4. This workflow will run again automatically

            ---
            ðŸ¤– Generated by [GitHub Actions](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `
            });

            console.log('Posted validation errors as commit comment');

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Data Upload Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.data_qa.outputs.status }}" == "0" ]; then
            echo "âœ… **Status**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Training data validated, versioned, and PR created." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Data validation failed. See errors in commit comment." >> $GITHUB_STEP_SUMMARY
          fi
