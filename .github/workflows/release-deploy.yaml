name: Release & Deploy

on:
  push:
    branches: [main]
    paths:
      - 'WMS/src/serve/**'      # Kod aplikacji serwisowej
      - 'docker/**'              # Dockerfile changes
      - 'devops/helm/**'         # Helm chart changes
      - 'infrastructure/helm-values.yaml'  # Deployment config
      - 'requirements.txt'       # Python dependencies
      - 'WMS/data/training/**'   # Training data (triggers deploy of new model from MLflow)
      - 'WMS/data/training/*.dvc'  # DVC metadata
  workflow_dispatch:  # Manual trigger
  workflow_call:  # Can be called by other workflows

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Must run on EC2 for localhost access to k3s and MLflow
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # No need to configure AWS credentials - EC2 instance has IAM role (LabInstanceProfile)
      # Self-hosted runner inherits EC2's instance profile credentials automatically

      - name: Login to ECR
        run: |
          python3 << 'EOF'
          import boto3
          import subprocess
          import base64

          ecr = boto3.client('ecr', region_name='us-east-1')
          token = ecr.get_authorization_token()
          auth_token = token['authorizationData'][0]['authorizationToken']
          username, password = base64.b64decode(auth_token).decode().split(':')

          subprocess.run([
              'docker', 'login',
              '--username', username,
              '--password-stdin',
              '055677744286.dkr.ecr.us-east-1.amazonaws.com'
          ], input=password.encode(), check=True)
          EOF

      - name: Build + Push Docker
        run: |
          ECR_REPO=055677744286.dkr.ecr.us-east-1.amazonaws.com/wms-model
          docker build -f docker/Dockerfile.serve -t $ECR_REPO:latest .
          docker push $ECR_REPO:latest

      - name: Deploy via Helm
        run: |
          helm upgrade --install wms-model devops/helm/ml-model/ \
            -f infrastructure/helm-values.yaml \
            --namespace model-$(git rev-parse --short HEAD) \
            --create-namespace
