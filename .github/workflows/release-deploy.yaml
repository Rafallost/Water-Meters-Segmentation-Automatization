name: Release & Deploy

on:
  push:
    branches: [main]
    paths:
      - 'WMS/src/serve/**'      # Serving application code
      - 'docker/**'              # Dockerfile changes
      - 'devops'                 # Submodule pointer update (gitlink)
      - 'devops/helm/**'         # Helm chart changes
      - '.gitmodules'            # Submodule configuration changes
      - 'infrastructure/helm-values.yaml'  # Deployment config
      - 'requirements.txt'       # Python dependencies
      # WMS/models/production_current.json intentionally excluded:
      # training-data-pipeline.yaml deploys inline after successful training
  workflow_dispatch:  # ⚠️ WARNING: Requires Production model in MLflow! Will fail if no model exists.

permissions:
  contents: read

jobs:
  # Start EC2 infrastructure using reusable workflow
  start-infra:
    name: Start EC2 Infrastructure
    uses: ./.github/workflows/ec2-control.yaml
    with:
      action: start
    secrets: inherit

  # Deploy model using reusable workflow
  deploy:
    name: Deploy to k3s
    needs: start-infra
    uses: ./.github/workflows/deploy-model.yaml
    with:
      trigger_reason: release
    secrets: inherit

  # Stop EC2 infrastructure using reusable workflow
  stop-infra:
    name: Stop EC2 Infrastructure
    needs: [start-infra, deploy]
    if: always()  # Stop even if deployment fails
    uses: ./.github/workflows/ec2-control.yaml
    with:
      action: stop
    secrets: inherit
