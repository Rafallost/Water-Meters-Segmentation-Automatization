name: Release & Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Must run on EC2 for localhost access to k3s and MLflow
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # No need to configure AWS credentials - EC2 instance has IAM role (LabInstanceProfile)
      # Self-hosted runner inherits EC2's instance profile credentials automatically

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region us-east-1 | \
            docker login --username AWS --password-stdin 055677744286.dkr.ecr.us-east-1.amazonaws.com

      - name: Build + Push Docker
        run: |
          ECR_REPO=055677744286.dkr.ecr.us-east-1.amazonaws.com/wms-model
          docker build -f docker/Dockerfile.serve -t $ECR_REPO:latest .
          docker push $ECR_REPO:latest

      - name: Deploy via Helm
        run: |
          helm upgrade --install wms-model devops/helm/ml-model/ \
            -f infrastructure/helm-values.yaml \
            --namespace model-$(git rev-parse --short HEAD) \
            --create-namespace
