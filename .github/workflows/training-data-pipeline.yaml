name: Training Data Pipeline

# Complete pipeline for training data changes:
# 1. Data QA validation
# 2. Create/Update Pull Request for review and training
#
# Note: Data merging is handled by the pre-push hook locally
# This workflow just validates and creates the PR

on:
  push:
    branches:
      - 'data/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install opencv-python numpy Pillow PyYAML

      - name: Run Data QA Validation
        id: data_qa
        run: |
          echo "Running data quality assurance..."
          python devops/scripts/data-qa.py WMS/data/training/ --output report.json

          # Capture exit code
          QA_STATUS=$?

          # Read report
          REPORT=$(cat report.json)

          # Set outputs
          echo "status=$QA_STATUS" >> $GITHUB_OUTPUT

          # Save report for PR comment
          echo "$REPORT" > qa_report.json

          if [ $QA_STATUS -ne 0 ]; then
            echo "âŒ Data QA failed!"
            exit 1
          fi

          echo "âœ… Data QA passed!"

      - name: Count training data
        id: count_data
        run: |
          IMAGE_COUNT=$(find WMS/data/training/images -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \) 2>/dev/null | wc -l)
          MASK_COUNT=$(find WMS/data/training/masks -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \) 2>/dev/null | wc -l)

          echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT
          echo "mask_count=$MASK_COUNT" >> $GITHUB_OUTPUT

          echo "Found $IMAGE_COUNT images and $MASK_COUNT masks"

      - name: Create or Update Pull Request
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const branch = context.ref.replace('refs/heads/', '');
            const report = JSON.parse(fs.readFileSync('qa_report.json', 'utf8'));

            // Check if PR already exists
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              base: 'main',
              state: 'open'
            });

            const prBody = `## Training Data Update - Validation PASSED âœ…

            New training data has been merged and validated successfully.

            ### Validation Report

            - **Images**: ${report.image_count || 'N/A'}
            - **Masks**: ${report.mask_count || 'N/A'}
            - **Valid pairs**: ${report.valid_pairs || 'N/A'}
            - **Resolution**: ${report.statistics?.resolution || 'N/A'}
            - **Median coverage**: ${report.statistics?.['median_coverage_%'] || 'N/A'}%

            ### Dataset Details

            This branch contains the **complete merged dataset**:
            - Existing data from S3 (if any)
            - New data added locally
            - Total: ${report.image_count || 'N/A'} training images

            ### Next Steps

            1. âœ… Data validation completed
            2. â³ Training pipeline will run automatically on this PR
            3. ðŸ“Š Quality gate will compare against Production baseline
            4. ðŸš€ If model improves, PR will be auto-approved
            5. âœ… Merge to deploy the new model

            ### Quality Gate

            The training pipeline will:
            - Train model on the **full dataset** (${report.image_count || 'N/A'} images)
            - Compare metrics (Dice, IoU) against Production baseline
            - Auto-approve if **both** metrics improve
            - Block merge if metrics don't improve

            ---
            ðŸ¤– Generated by [GitHub Actions](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;

            if (existingPRs.length > 0) {
              // Update existing PR
              const pr = existingPRs[0];
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: prBody
              });
              console.log(`âœ… Updated existing PR #${pr.number}`);
            } else {
              // Create new PR
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Training Data Update: ${branch}`,
                head: branch,
                base: 'main',
                body: prBody
              });
              console.log(`âœ… Created PR #${pr.data.number}`);
            }

      - name: Post validation errors (if failed)
        if: failure() && steps.data_qa.outputs.status != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report;
            try {
              report = JSON.parse(fs.readFileSync('qa_report.json', 'utf8'));
            } catch (e) {
              report = { error: 'Could not read QA report' };
            }

            let errorList = '';
            if (report.errors && report.errors.length > 0) {
              errorList = report.errors.slice(0, 10).map(e => `- ${e}`).join('\n');
              if (report.errors.length > 10) {
                errorList += `\n- ... and ${report.errors.length - 10} more errors`;
              }
            }

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## Data Validation FAILED âŒ

            Training data validation failed. Please fix the following issues and push again.

            ### Errors

            ${errorList || 'Unknown error - check workflow logs'}

            ### Statistics

            - **Images**: ${report.image_count || 0}
            - **Masks**: ${report.mask_count || 0}
            - **Valid pairs**: ${report.valid_pairs || 0}

            ### How to Fix

            1. Review the errors above
            2. Fix the issues in your local repository
            3. Commit and push to the same branch (\`${context.ref.replace('refs/heads/', '')}\`)
            4. This workflow will run again automatically

            ---
            ðŸ¤– Generated by [GitHub Actions](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `
            });

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Training Data Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.data_qa.outputs.status }}" == "0" ]; then
            echo "âœ… **Status**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Training data validated and PR created." >> $GITHUB_STEP_SUMMARY
            echo "Training pipeline will run automatically." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Data validation failed. See errors in commit comment." >> $GITHUB_STEP_SUMMARY
          fi
